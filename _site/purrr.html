<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.245">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Emorie D Beck">

<title>Emorie D. Beck, PhD - Intro to purrr</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./ggplot2.html" rel="next">
<link href="./dplyr.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating nav-fixed">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Emorie D. Beck, PhD</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html">About</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./publications.html">Publications</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./projects.html">Projects</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./tutorials.html" aria-current="page">Tutorials</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./talks.html">Talks</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./teaching.html">Teaching</a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Intro to <code>purrr</code></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorials.html" class="sidebar-item-text sidebar-link">Tutorials</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dplyr.html" class="sidebar-item-text sidebar-link">Data Manipulation: Intro to <code>dplyr</code></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./purrr.html" class="sidebar-item-text sidebar-link active">Intro to <code>purrr</code></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ggplot2.html" class="sidebar-item-text sidebar-link">Introduction to ggplot2</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tables.html" class="sidebar-item-text sidebar-link">APA Tables Part 1</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow.html" class="sidebar-item-text sidebar-link">Codebooks and Workflow</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./descriptives.html" class="sidebar-item-text sidebar-link">Codebooks and Workflow Part 2</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#nested-data-frames" id="toc-nested-data-frames" class="nav-link active" data-scroll-target="#nested-data-frames">Nested Data Frames</a></li>
  <li><a href="#the-map-functions" id="toc-the-map-functions" class="nav-link" data-scroll-target="#the-map-functions">The <code>map()</code> Functions</a>
  <ul class="collapse">
  <li><a href="#map" id="toc-map" class="nav-link" data-scroll-target="#map"><code>map()</code></a></li>
  <li><a href="#plyr-alternative" id="toc-plyr-alternative" class="nav-link" data-scroll-target="#plyr-alternative"><code>plyr</code> alternative</a></li>
  <li><a href="#the-for-loop-alternative" id="toc-the-for-loop-alternative" class="nav-link" data-scroll-target="#the-for-loop-alternative">The for Loop Alternative</a></li>
  </ul></li>
  <li><a href="#unnesting" id="toc-unnesting" class="nav-link" data-scroll-target="#unnesting">Unnesting</a></li>
  <li><a href="#create-a-table" id="toc-create-a-table" class="nav-link" data-scroll-target="#create-a-table">Create a Table</a></li>
  <li><a href="#plots" id="toc-plots" class="nav-link" data-scroll-target="#plots">Plots</a>
  <ul class="collapse">
  <li><a href="#one-big-plot" id="toc-one-big-plot" class="nav-link" data-scroll-target="#one-big-plot">One Big Plot</a></li>
  <li><a href="#predicted-values" id="toc-predicted-values" class="nav-link" data-scroll-target="#predicted-values">Predicted Values</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Intro to <code>purrr</code></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Emorie D Beck </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<p><a href="https://raw.githubusercontent.com/emoriebeck/R-tutorials/master/05_purrr/purrr_tutorial.Rmd" download="">Download .Rmd (won’t work in Safari or IE)</a><br>
<a href="https://github.com/emoriebeck/R-tutorials/tree/master/05_purrr" target="_blank">See GitHub Repository</a></p>
<p>#<code>purrr</code> In my opinion, purrr is one of the most underrated and under-utilized <code>R</code> packages.</p>
<p>#Background: iteration Iteration is everywhere. It underpins much of mathematics and statistics. If you’ve ever seen the <span class="math inline">\(\Sigma\)</span> symbol, then you’ve seen (and probably used) iteration.</p>
<p>It’s also incredibly useful. Anytime you have to repeat some sort of action many times, iteration is your best friend. In psychology, this often means reading in a bunch of individual data files from an experiment, repeating an analysis with a series of different predictors or outcomes, or creating a series of figures.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(psych)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plyr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Enter <code>for</code> loops. <code>for</code> loops are the “OG” form of iteration in computer science. The basic syntax is below. Basically, we can use a for loop to loop through and print a series of things.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]){</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a"
[1] "b"
[1] "c"
[1] "d"
[1] "e"</code></pre>
</div>
</div>
<p>In psychology, we deal with all sorts of weird sorts of data frames. From longitudinal data with separate files for each year to experimental data with separate data for each participant (if you’re “lucky,” you might even get both!), data are often stored as separate files. THe good news is that <code>for</code> loops are here to save you from:</p>
<ol>
<li>
Writing code to load in each file separately (not good).
</li>
<li>
Copying each data file into one larger data set in Excel (worse)
</li>
</ol>
<p>Assuming you have all the data in a single folder and the format is reasonably similar, you have the following basic syntax:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>data_path <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(data_path)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> files){</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  data[[i]] <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(i, <span class="at">stringsAsFactors =</span> F)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">combine</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The loop above defines the path of the data, reads all the files in that path, creates an empty list to store the data files, loops through each of the files individually and saves them into the list, and combines each of the read data files into a single data frame.</p>
<p>This is all well and good and would work just fine. But what happens if you have multiple data files for different subjects if, say, they complete a writing task and a memory task? Or maybe you work with longitudinal data, like I do, and frequently have multiple data files for a given year for different categories (e.g.&nbsp;health, psychological, etc.). In that case, the loop above might not work. The files might have different properties or be stored in different locations (for your own sanity).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>data_path <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>directories <span class="ot">&lt;-</span> <span class="fu">list.files</span>(data_path)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"health"</span>, <span class="st">"person"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data.frame</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> directories){</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> files){</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">sprintf</span>(<span class="st">"%s/%s/%s.csv"</span>, data_path, i, k), <span class="at">stringsAsFactors =</span> F)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    tmp<span class="sc">$</span>file <span class="ot">&lt;-</span> k</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(data, tmp)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this case, it’s a little more complicated. First, our method for loading each of the files into a list doesn’t work nicely here because we are iterating through 2 variables. As a result, we have to save each file into an object called “tmp” that then must be joined with data from previous iterations. The downside of this is that we have to use a sort of “brute-force” method to do so, which is not ideal. Things go wrong with data collection quite often, meaning that files are likely to have different columns. Third, when a loop fails, it refuses to continue. And you are left with a couple of variables (i and k) and have to try to work backward to figure out what is going wrong.</p>
<p>Sound annoying? Enter <code>purrr</code>.</p>
<p>#The purrr solution purrr is my favorite alternative to iteration. (There’s also the whole <code>apply</code> family, which is definitely worth learning – even I still use it – but I find <code>purrr</code> to be much more useful in the long run.) <code>purrr</code> keeps me organized by keeping everything together in a single object. It works nicely with functions like <code>possibly()</code> and <code>safely()</code> that catch and handle errors.</p>
<p><code>purrr</code> can be used for many more things than I will talk about here. If you want to know more, you can check out Hadley Wickham’s <a href="https://r4ds.had.co.nz/">R for Data Science</a> or <code>purrr</code> documentation. I’m going to focus on how <em>I</em> I use <code>purrr</code>: reading data, cleaning, running models, making tables, and making plots.</p>
<p>Here’s some <code>purrr</code> syntax I won’t explain now. It’s set up to mirror the demonstration above. It will make way more sense soon, I promise:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>read_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(pid, dir){</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sprintf</span>(<span class="st">"%s/%s/%s.csv"</span>, data_path, dir, pid) <span class="sc">%&gt;%</span> read_csv</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>data_path <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">list.files</span>(data_path)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">file =</span> file) <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">str_remove_all</span>(file, <span class="st">".csv"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(file, <span class="fu">c</span>(<span class="st">"PID"</span>, <span class="st">"directory"</span>), <span class="at">sep =</span> <span class="st">"_"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map2_df</span>(PID, directory, read_fun)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data, <span class="at">.drop =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Beyond “WTF”, your initial response may be “this is not more efficient than the nested <code>for</code> loop you showed us above.” You are partially correct. The rest of the tutorial will be showing you why being wrong now will sooooo right later!</p>
<section id="nested-data-frames" class="level2">
<h2 class="anchored" data-anchor-id="nested-data-frames">Nested Data Frames</h2>
<p>Before we can learn how to use <code>purrr</code>, we need to understand what a nested data frame is. If you’ve ever worked with a list in R, you are halfway there. Basically a nested data frame takes the normal data frame you are probably familiar with and adds some new features. It still has columns, rows, and cells, but what makes up those cells isn’t restrictred to numbers, strings, or logicals. Instead, you can put essentially anything you want: lists, models, data frames, plots, etc!</p>
<p>If that freaks you out a bit, imagine this. Imagine you are me: you work with personality data and want to use each of the Big 5 to individually predict some outcomes, like health and life satisfaction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ipip50 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">url</span>(<span class="st">"https://media.githubusercontent.com/media/emoriebeck/R-tutorials/master/05_purrr/ipip50_sample.csv"</span>), <span class="at">stringsAsFactors =</span> F)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># let's recode the exercise variable (exer)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 = "veryRarelyNever"; 1 = "less1mo"; 2 = "less1wk"; 3 = "1or2wk"; 4 = "3or5wk"; 5 = "more5wk"</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>ipip50 <span class="ot">&lt;-</span> ipip50 <span class="sc">%&gt;%</span> </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">exer =</span> <span class="fu">mapvalues</span>(exer, <span class="fu">unique</span>(exer), <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">2</span>,<span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The really bad solution would be to write the code to model these data, make a table of the results, and make a plot. Then you would copy and paste that code 9 times to do the same steps for the other trait-outcome pairs, changing the key variables. Sometime later, you could run those individually.</p>
<p>A better solution would be a loop, where you use a nested loop to complete the steps for each trait-outcome pair. How you store these values can be a little wonky and often involes a bunch of different lists or a cluttered global environment with losts of objects.</p>
<p>But the best solution is purrr. What does this look like? Well, we start with a nested data frame. To do that, we need to make sure our data is ready. I’ve found that the easiest way to work with data with purrr is to first convert your data to long form, where we want to have columns for all the variable we would want to iterate through in a loop. To help you understand what that means and looks like, I think it’s useful to start with a non-nested data frame created by the <code>crossing()</code> function from the <code>dplyr</code> package.</p>
<p>Basically, <code>crossing()</code> takes what you give it and returns a data frame with all combinations of the variables. There is no limit to the number of columns this can have. Here, we feed it “Trait”, which contains a vector of the Big 5, and “Outcome”, which contains a vector of our outcomes, which results in a data frame with 2 columns and 10 rows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>(df <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Trait =</span> <span class="fu">c</span>(<span class="st">"E"</span>, <span class="st">"A"</span>, <span class="st">"C"</span>, <span class="st">"N"</span>, <span class="st">"O"</span>),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Outcome =</span> <span class="fu">c</span>(<span class="st">"BMI"</span>, <span class="st">"logMedInc"</span>, <span class="st">"exer"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Trait   Outcome
1      E       BMI
2      A       BMI
3      C       BMI
4      N       BMI
5      O       BMI
6      E logMedInc
7      A logMedInc
8      C logMedInc
9      N logMedInc
10     O logMedInc
11     E      exer
12     A      exer
13     C      exer
14     N      exer
15     O      exer</code></pre>
</div>
</div>
<p>One cool thing this will allow us to do is to use consistent variable names in formulas and functions and to feed the correct data into different programs using the <code>dplyr</code> helper function <code>filter()</code>. You can use expand grid with purrr functions without nesting any data in the data frame (in fact, I do this a lot because I work with large data sets and lots of combinations), but I’m going to show you the nested data frame route in this case and refer you to my GitHub for when and how you would use the <code>crossing()</code> approach.</p>
<p>Back to nested data frames. We want to end up with a data frame that has the same columns as the <code>crossing()</code> data frame except that we want an additional column that holds the data for each trait-outcome pair. To do this, we need to have a column that indexes both trait and outcome. To get this, we change our data to the “tidy” format using <code>gather()</code> in the <code>tidyr</code> package.</p>
<p>So let’s take our Big 5 data and do that.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's make the trait data long and create composites</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>(ipip50_composites <span class="ot">&lt;-</span> ipip50 <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="at">key =</span> item, <span class="at">value =</span> value, A_1<span class="sc">:</span>O_10) <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(item, <span class="fu">c</span>(<span class="st">"Trait"</span>, <span class="st">"item"</span>), <span class="at">sep =</span> <span class="st">"_"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(RID, gender, age, BMI, exer, logMedInc, Trait) <span class="sc">%&gt;%</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">t.value =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> T)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,000 × 8
# Groups:   RID, gender, age, BMI, exer, logMedInc [1,000]
       RID gender   age   BMI exer  logMedInc Trait t.value
     &lt;int&gt; &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;
 1 3078429 female    27  28.0 3          10.7 A        5.41
 2 3078429 female    27  28.0 3          10.7 C        4.77
 3 3078429 female    27  28.0 3          10.7 E        6.03
 4 3078429 female    27  28.0 3          10.7 N        5.65
 5 3078429 female    27  28.0 3          10.7 O        4.01
 6 4310942 female    35  28.4 4          10.7 A        4.63
 7 4310942 female    35  28.4 4          10.7 C        4.77
 8 4310942 female    35  28.4 4          10.7 E        5.00
 9 4310942 female    35  28.4 4          10.7 N        3.11
10 4310942 female    35  28.4 4          10.7 O        6.78
# … with 4,990 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's make the outcomes long</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ipip50_composites <span class="ot">&lt;-</span> ipip50_composites <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="at">key =</span> Outcome, <span class="at">value =</span> o.value, BMI<span class="sc">:</span>logMedInc) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that our data is in long format, we have a couple of options. The first is to use the <code>nest()</code> function from the <code>tidyr</code> package to chunk our data by trait and outcome. This will result in a data frame with 3 columns: 1 that indexes the Trait, one that indexes the Outcome, and one that indexes the data for that trait and outcome combination.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>(ipip50_nested <span class="ot">&lt;-</span> ipip50_composites <span class="sc">%&gt;%</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Trait, Outcome) <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 3
   Trait Outcome   data                
   &lt;chr&gt; &lt;chr&gt;     &lt;list&gt;              
 1 A     BMI       &lt;tibble [1,000 × 5]&gt;
 2 C     BMI       &lt;tibble [1,000 × 5]&gt;
 3 E     BMI       &lt;tibble [1,000 × 5]&gt;
 4 N     BMI       &lt;tibble [1,000 × 5]&gt;
 5 O     BMI       &lt;tibble [1,000 × 5]&gt;
 6 A     exer      &lt;tibble [1,000 × 5]&gt;
 7 C     exer      &lt;tibble [1,000 × 5]&gt;
 8 E     exer      &lt;tibble [1,000 × 5]&gt;
 9 N     exer      &lt;tibble [1,000 × 5]&gt;
10 O     exer      &lt;tibble [1,000 × 5]&gt;
11 A     logMedInc &lt;tibble [1,000 × 5]&gt;
12 C     logMedInc &lt;tibble [1,000 × 5]&gt;
13 E     logMedInc &lt;tibble [1,000 × 5]&gt;
14 N     logMedInc &lt;tibble [1,000 × 5]&gt;
15 O     logMedInc &lt;tibble [1,000 × 5]&gt;</code></pre>
</div>
</div>
<p>Basically, instead of the cells in the “data” column being a single numeric, logical, or character value, each cell is a data frame! Note that the class of the “data” column is a list (hence the name “list column”) and the class of each cell is a tibble. o_O Pretty cool, huh? Here’s why: by putting a data frame of the data for each trait / outcome combination in a single cell, we can operate on each cell like we would a cell in a normal data frame. Sort of.</p>
</section>
<section id="the-map-functions" class="level2 tabset">
<h2 class="tabset anchored" data-anchor-id="the-map-functions">The <code>map()</code> Functions</h2>
<p>I say sort of because we need another function, this time from the <code>purrr</code> package (yay!) called <code>map()</code>. Now my purpose here isn’t to go through every possible way you can use this. If you want to learn more of the ins and outs see http://r4ds.had.co.nz/many-models.html. My goal is to show you how I, a psychology grad student, uses purrr every. single. day. in my research.</p>
<p>What we want to do is to run a model using personality to predict our outcomes for each combination of trait and outcome. Now that we have a data frame for each nested in a data frame, we’re ready to do that. Here’s how.</p>
<section id="map" class="level3">
<h3 class="anchored" data-anchor-id="map"><code>map()</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>(ipip50_nested <span class="ot">&lt;-</span> ipip50_nested <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">lm</span>(o.value <span class="sc">~</span> t.value, <span class="at">data =</span> .))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 4
   Trait Outcome   data                 model 
   &lt;chr&gt; &lt;chr&gt;     &lt;list&gt;               &lt;list&gt;
 1 A     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
 2 C     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
 3 E     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
 4 N     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
 5 O     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
 6 A     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
 7 C     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
 8 E     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
 9 N     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
10 O     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
11 A     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
12 C     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
13 E     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
14 N     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  
15 O     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(end_time <span class="sc">-</span> start_time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 0.09020615 secs</code></pre>
</div>
</div>
<p>What’s going on there? Well, we’re using <code>mutate()</code> from dplyr to create a new column in our data frame called “model.” Then, we use the <code>map()</code> function to tell it that we want to take each of the cells in the “data” column and run a linear model predicting our outcomes (o.value) from personality (t.value). The “data = .” part follows because we are within a <code>dplyr</code> pipe.</p>
<p>As you can see, this results in a new column called “model.” As with the data column, the class of the “model” column is a list, and the class of any individual cell in the column is the S3 class “lm”, which just means linear model.</p>
<p>Now, this is definitely a fast way to run a lot of models, but thus far, this isn’t better than a for loop. But our nested data frame can way outperform a for loop. We don’t run models just for the sake of doing so. We want to extract the information and report it, often in either a table or figure. With <code>map()</code> and <code>purrr</code>, we can create a table and figure for each model and <em>store it in our data frame</em>. No more dealing with clunky lists whose contents is hard to access or seemingly infinite numbers of objects cluttering your environment. It’s all stored in ONE DATA FRAME. (Sorry to shout, but I think the advantages of this cannot be overstated.)</p>
<p>Watch:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>(ipip50_nested <span class="ot">&lt;-</span> ipip50_nested <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tidy =</span> <span class="fu">map</span>(model, broom<span class="sc">::</span>tidy)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 5
   Trait Outcome   data                 model  tidy            
   &lt;chr&gt; &lt;chr&gt;     &lt;list&gt;               &lt;list&gt; &lt;list&gt;          
 1 A     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 2 C     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 3 E     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 4 N     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 5 O     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 6 A     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 7 C     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 8 E     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 9 N     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
10 O     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
11 A     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
12 C     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
13 E     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
14 N     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
15 O     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;</code></pre>
</div>
</div>
</section>
<section id="plyr-alternative" class="level3">
<h3 class="anchored" data-anchor-id="plyr-alternative"><code>plyr</code> alternative</h3>
<p>To be fair, there are other alternative, like <code>dlply()</code> in the <code>plyr</code> package. I’ll demonstrate it below then make a case for why not to do this.</p>
<p>So if we start by taking our long format data frame, we can use a very similar format to map to create a list of models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">dlply</span>(ipip50_composites, .(Trait, Outcome), <span class="cf">function</span>(x) <span class="fu">lm</span>(o.value <span class="sc">~</span> t.value, <span class="at">data =</span> x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we could again use <code>tidy()</code> from <code>broom</code> to get summaries.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>tidies <span class="ot">&lt;-</span> <span class="fu">llply</span>(models, broom<span class="sc">::</span>tidy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then use <code>combine()</code> from <code>dplyr</code> to merge them. BUT, we have a problem. (1) We have a weird, nested list, and (2) <code>combine()</code> doesn’t index our grouping variables like our nested data frame + <code>map()</code>.</p>
</section>
<section id="the-for-loop-alternative" class="level3">
<h3 class="anchored" data-anchor-id="the-for-loop-alternative">The for Loop Alternative</h3>
<p>Okay, but we can do this with a for loop, so why not? My rationale is that it makes my brain hurt to write a loop that is half as functional the purrr solution. Watch:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>Traits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"E"</span>, <span class="st">"A"</span>, <span class="st">"C"</span>, <span class="st">"N"</span>, <span class="st">"O"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>Outcomes <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">c</span>(<span class="st">"BMI"</span>, <span class="st">"logMedInc"</span>, <span class="st">"exer"</span>))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>ipip50_loop <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>counter <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (trait <span class="cf">in</span> Traits){</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outcome <span class="cf">in</span> Outcomes){</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> ipip50_composites <span class="sc">%&gt;%</span> </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(Trait <span class="sc">==</span> trait <span class="sc">&amp;</span> Outcome <span class="sc">==</span> outcome)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Trait =</span> trait, <span class="at">Outcome =</span> outcome)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    tmp<span class="sc">$</span>model <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">lm</span>(o.value <span class="sc">~</span> t.value, <span class="at">data =</span> df))</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    ipip50_loop[[counter]] <span class="ot">&lt;-</span> tmp</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    counter <span class="ot">&lt;-</span> counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(end_time <span class="sc">-</span> start_time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 0.4015951 secs</code></pre>
</div>
</div>
<p>This took a lot more lines of code and also took longer. For a few models with a small data set, this doesn’t matter much. But when you work with hundreds of models with 10’s or 100’s of thousands of observations, this adds up.</p>
<p>So the lesson here is just use <code>purrr.</code> Please.</p>
</section>
</section>
<section id="unnesting" class="level2">
<h2 class="anchored" data-anchor-id="unnesting">Unnesting</h2>
<p>Using the <code>tidy()</code> function from the <code>broom</code> package, we now have another column. Again, the column’s class is “list” but the cell’s class is “data.frame”. How can we use this? Well, the <code>nest()</code> function we used earlier has a sibling called <code>unnest()</code>. It does the opposite of <code>nest()</code>; it takes our list columns and expands it. So, since we have 2 x 5 data frame in each cell of the “tidy” column, when we unnest it, there will be rows for each Trait and outcome combination (where there was only 1 in the nested data frame). This will make more sense with a demonstration:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>ipip50_nested <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Trait, Outcome, tidy) <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(tidy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 7
   Trait Outcome term        estimate std.error statistic   p.value
   &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
 1 A     BMI     (Intercept)  25.3        1.10    23.0    2.11e- 94
 2 A     BMI     t.value       0.0627     0.229    0.274  7.84e-  1
 3 C     BMI     (Intercept)  26.2        0.928   28.3    1.54e-129
 4 C     BMI     t.value      -0.152      0.220   -0.691  4.89e-  1
 5 E     BMI     (Intercept)  25.7        0.667   38.5    1.34e-199
 6 E     BMI     t.value      -0.0228     0.172   -0.133  8.94e-  1
 7 N     BMI     (Intercept)  25.9        0.667   38.8    2.28e-201
 8 N     BMI     t.value      -0.0763     0.181   -0.423  6.73e-  1
 9 O     BMI     (Intercept)  25.5        0.947   26.9    1.55e-120
10 O     BMI     t.value       0.0167     0.199    0.0840 9.33e-  1
# … with 20 more rows</code></pre>
</div>
</div>
<p>Pretty neat, huh? From here, we may want to do a bunch of different things. And <code>purrr</code> is our friend for all of them. I’m going to do a few below, just to show you your options.</p>
</section>
<section id="create-a-table" class="level2">
<h2 class="anchored" data-anchor-id="create-a-table">Create a Table</h2>
<p>When we have multiple predictors and outcomes, we typically want to smash all this info into a single table, with predictors as different rows of the table and outcomes as different columns (or vice versa). We typically include both an estimate and a confidence interval or standard error for each term in the model (in our case Intercept and t.value).</p>
<p>Let’s create a table with different columns for each of the outcomes, and different rows for each trait:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>(tab <span class="ot">&lt;-</span> ipip50_nested <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Trait, Outcome, tidy) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(tidy) <span class="sc">%&gt;%</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Trait<span class="sc">:</span>std.error) <span class="sc">%&gt;%</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">b =</span> estimate, <span class="at">SE =</span> std.error) <span class="sc">%&gt;%</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="at">key =</span> tmp, <span class="at">value =</span> value, b, SE) <span class="sc">%&gt;%</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unite</span>(tmp, Outcome, tmp, <span class="at">sep =</span> <span class="st">"."</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread</span>(<span class="at">key =</span> tmp, <span class="at">value =</span> value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 8
   Trait term          BMI.b BMI.SE  exer.b exer.SE logMedInc.b logMedInc.SE
   &lt;chr&gt; &lt;chr&gt;         &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;
 1 A     (Intercept) 25.3     1.10   2.11    0.282    10.9            0.0711
 2 A     t.value      0.0627  0.229  0.122   0.0589    0.00765        0.0148
 3 C     (Intercept) 26.2     0.928  2.02    0.238    10.9            0.0601
 4 C     t.value     -0.152   0.220  0.162   0.0566   -0.000788       0.0143
 5 E     (Intercept) 25.7     0.667  2.40    0.171    10.9            0.0431
 6 E     t.value     -0.0228  0.172  0.0749  0.0442   -0.00260        0.0111
 7 N     (Intercept) 25.9     0.667  3.20    0.171    10.9            0.0432
 8 N     t.value     -0.0763  0.181 -0.146   0.0463    0.00565        0.0117
 9 O     (Intercept) 25.5     0.947  2.92    0.244    10.8            0.0612
10 O     t.value      0.0167  0.199 -0.0506  0.0513    0.0207         0.0129</code></pre>
</div>
</div>
<p>We aren’t quite done yet. This table would never make it in a publication. Enter <code>kable()</code> + <code>kableExtra</code>.</p>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>tab <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>Trait) <span class="sc">%&gt;%</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(., <span class="st">"html"</span>, <span class="at">booktabs =</span> T, <span class="at">escape =</span> F, <span class="at">digits =</span> <span class="dv">2</span>,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Term"</span>, <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"b"</span>, <span class="st">"SE"</span>), <span class="at">times =</span> <span class="dv">3</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">width =</span> <span class="st">"2cm"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">group_rows</span>(<span class="st">"Agreeableness"</span>,<span class="dv">1</span>,<span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">group_rows</span>(<span class="st">"Conscientiousness"</span>,<span class="dv">3</span>,<span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">group_rows</span>(<span class="st">"Extraversion"</span>,<span class="dv">5</span>,<span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">group_rows</span>(<span class="st">"Neuroticism"</span>,<span class="dv">7</span>,<span class="dv">8</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">group_rows</span>(<span class="st">"Openness"</span>,<span class="dv">9</span>,<span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">" "</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"BMI"</span> <span class="ot">=</span> <span class="dv">2</span>, <span class="st">"Exercise"</span> <span class="ot">=</span> <span class="dv">2</span>, <span class="st">"Log Median Income"</span> <span class="ot">=</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
<tr>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="1"></th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">BMI</div></th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">Exercise</div></th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">Log Median Income</div></th>
</tr>
  <tr>
   <th style="text-align:left;"> Term </th>
   <th style="text-align:right;"> b </th>
   <th style="text-align:right;"> SE </th>
   <th style="text-align:right;"> b </th>
   <th style="text-align:right;"> SE </th>
   <th style="text-align:right;"> b </th>
   <th style="text-align:right;"> SE </th>
  </tr>
 </thead>
<tbody>
  <tr grouplength="2"><td colspan="7" style="border-bottom: 1px solid;"><strong>Agreeableness</strong></td></tr>
<tr>
   <td style="text-align:left;padding-left: 2em;" indentlevel="1"> (Intercept) </td>
   <td style="text-align:right;width: 2cm; "> 25.29 </td>
   <td style="text-align:right;width: 2cm; "> 1.10 </td>
   <td style="text-align:right;width: 2cm; "> 2.11 </td>
   <td style="text-align:right;width: 2cm; "> 0.28 </td>
   <td style="text-align:right;width: 2cm; "> 10.89 </td>
   <td style="text-align:right;width: 2cm; "> 0.07 </td>
  </tr>
  <tr>
   <td style="text-align:left;padding-left: 2em;" indentlevel="1"> t.value </td>
   <td style="text-align:right;width: 2cm; "> 0.06 </td>
   <td style="text-align:right;width: 2cm; "> 0.23 </td>
   <td style="text-align:right;width: 2cm; "> 0.12 </td>
   <td style="text-align:right;width: 2cm; "> 0.06 </td>
   <td style="text-align:right;width: 2cm; "> 0.01 </td>
   <td style="text-align:right;width: 2cm; "> 0.01 </td>
  </tr>
  <tr grouplength="2"><td colspan="7" style="border-bottom: 1px solid;"><strong>Conscientiousness</strong></td></tr>
<tr>
   <td style="text-align:left;padding-left: 2em;" indentlevel="1"> (Intercept) </td>
   <td style="text-align:right;width: 2cm; "> 26.21 </td>
   <td style="text-align:right;width: 2cm; "> 0.93 </td>
   <td style="text-align:right;width: 2cm; "> 2.02 </td>
   <td style="text-align:right;width: 2cm; "> 0.24 </td>
   <td style="text-align:right;width: 2cm; "> 10.93 </td>
   <td style="text-align:right;width: 2cm; "> 0.06 </td>
  </tr>
  <tr>
   <td style="text-align:left;padding-left: 2em;" indentlevel="1"> t.value </td>
   <td style="text-align:right;width: 2cm; "> -0.15 </td>
   <td style="text-align:right;width: 2cm; "> 0.22 </td>
   <td style="text-align:right;width: 2cm; "> 0.16 </td>
   <td style="text-align:right;width: 2cm; "> 0.06 </td>
   <td style="text-align:right;width: 2cm; "> 0.00 </td>
   <td style="text-align:right;width: 2cm; "> 0.01 </td>
  </tr>
  <tr grouplength="2"><td colspan="7" style="border-bottom: 1px solid;"><strong>Extraversion</strong></td></tr>
<tr>
   <td style="text-align:left;padding-left: 2em;" indentlevel="1"> (Intercept) </td>
   <td style="text-align:right;width: 2cm; "> 25.67 </td>
   <td style="text-align:right;width: 2cm; "> 0.67 </td>
   <td style="text-align:right;width: 2cm; "> 2.40 </td>
   <td style="text-align:right;width: 2cm; "> 0.17 </td>
   <td style="text-align:right;width: 2cm; "> 10.94 </td>
   <td style="text-align:right;width: 2cm; "> 0.04 </td>
  </tr>
  <tr>
   <td style="text-align:left;padding-left: 2em;" indentlevel="1"> t.value </td>
   <td style="text-align:right;width: 2cm; "> -0.02 </td>
   <td style="text-align:right;width: 2cm; "> 0.17 </td>
   <td style="text-align:right;width: 2cm; "> 0.07 </td>
   <td style="text-align:right;width: 2cm; "> 0.04 </td>
   <td style="text-align:right;width: 2cm; "> 0.00 </td>
   <td style="text-align:right;width: 2cm; "> 0.01 </td>
  </tr>
  <tr grouplength="2"><td colspan="7" style="border-bottom: 1px solid;"><strong>Neuroticism</strong></td></tr>
<tr>
   <td style="text-align:left;padding-left: 2em;" indentlevel="1"> (Intercept) </td>
   <td style="text-align:right;width: 2cm; "> 25.86 </td>
   <td style="text-align:right;width: 2cm; "> 0.67 </td>
   <td style="text-align:right;width: 2cm; "> 3.20 </td>
   <td style="text-align:right;width: 2cm; "> 0.17 </td>
   <td style="text-align:right;width: 2cm; "> 10.91 </td>
   <td style="text-align:right;width: 2cm; "> 0.04 </td>
  </tr>
  <tr>
   <td style="text-align:left;padding-left: 2em;" indentlevel="1"> t.value </td>
   <td style="text-align:right;width: 2cm; "> -0.08 </td>
   <td style="text-align:right;width: 2cm; "> 0.18 </td>
   <td style="text-align:right;width: 2cm; "> -0.15 </td>
   <td style="text-align:right;width: 2cm; "> 0.05 </td>
   <td style="text-align:right;width: 2cm; "> 0.01 </td>
   <td style="text-align:right;width: 2cm; "> 0.01 </td>
  </tr>
  <tr grouplength="2"><td colspan="7" style="border-bottom: 1px solid;"><strong>Openness</strong></td></tr>
<tr>
   <td style="text-align:left;padding-left: 2em;" indentlevel="1"> (Intercept) </td>
   <td style="text-align:right;width: 2cm; "> 25.51 </td>
   <td style="text-align:right;width: 2cm; "> 0.95 </td>
   <td style="text-align:right;width: 2cm; "> 2.92 </td>
   <td style="text-align:right;width: 2cm; "> 0.24 </td>
   <td style="text-align:right;width: 2cm; "> 10.83 </td>
   <td style="text-align:right;width: 2cm; "> 0.06 </td>
  </tr>
  <tr>
   <td style="text-align:left;padding-left: 2em;" indentlevel="1"> t.value </td>
   <td style="text-align:right;width: 2cm; "> 0.02 </td>
   <td style="text-align:right;width: 2cm; "> 0.20 </td>
   <td style="text-align:right;width: 2cm; "> -0.05 </td>
   <td style="text-align:right;width: 2cm; "> 0.05 </td>
   <td style="text-align:right;width: 2cm; "> 0.02 </td>
   <td style="text-align:right;width: 2cm; "> 0.01 </td>
  </tr>
</tbody>
</table>

</div>
<p>Now I would usually get fancy and bold or flag significant values. I would also use confidence intervals rather than standard errors and add some additional rows with some model summary terms (e.g.&nbsp;<span class="math inline">\(R^2\)</span>). If you want to see that, I’ll refer you to my github.</p>
</section>
<section id="plots" class="level2">
<h2 class="anchored" data-anchor-id="plots">Plots</h2>
<section id="one-big-plot" class="level3">
<h3 class="anchored" data-anchor-id="one-big-plot">One Big Plot</h3>
<p>Sometimes, we want one big plot that shows all our results. What kind of plot? You have choice. Line graphs are popular, but they are perhaps overly simple for these simple linear relationships. We’d also have to go back and get predicted values, which is helpful, but again I’ll refer you to my github for more on that. Instead, we’re going to create a forest plot, which is useful for determining which terms are different than 0 and how those relate to other terms. We can do this for both our model terms (Intercept and t.value), but I’m going to restrict us to t.value, which tells us how a 1 point increase in a personality characteristic is associated with an outcome.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>ipip50_nested <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Trait, Outcome, tidy) <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(tidy) <span class="sc">%&gt;%</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"t.value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Trait, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="dv">0</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> estimate <span class="sc">-</span> std.error, <span class="at">ymax =</span> estimate <span class="sc">+</span> std.error),</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">width =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> Trait), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>Outcome, <span class="at">scale =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="purrr_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Pretty cool. We see that personality predicts exercise pretty much across the board, but that it does not predict BMI. Only Openness predicts log Median Income.</p>
<p>But here’s where we pat ourselves on the back. We got from nesting our data to the plot above in FIFTEEN LINES OF CODE. Without purrr, it would take us that many lines just to run our models. Then we’d still need to tidy them, join them back together, and plot. I don’t want to do that. Or we could use a loop, and create a weird series of lists or a cluttered environment. No thank you on all accounts.</p>
</section>
<section id="predicted-values" class="level3">
<h3 class="anchored" data-anchor-id="predicted-values">Predicted Values</h3>
<p>But you will encounter times when you want to do predicted values. There are a number of ways to go about this (and both of these ignore that you can just use <code>geom_smooth()</code> in the <code>ggplot2</code> package with method = “lm” for simple linear models). I’m going to show you 2 purrrfect ways. Because demonstrations.</p>
<section id="single-plots" class="level4">
<h4 class="anchored" data-anchor-id="single-plots">Single Plots</h4>
<p>First, let’s get predicted values for each model. We’ll use <code>expand.grid()</code> to get the full range of values for each personality traits (1 to 7) and then use the <code>predict()</code> function to get the predicted values, setting the “newdata” argument to the newly created range of personality values.</p>
<p>To do this, I’m also going to introduce something that is central to <code>purrr</code> programming: local functions. As a general rule, if you ever have to do something multiple times, write a function. Save yourself. Please. When writing functions for <code>purrr</code>, the basic mindframe I use is to make the inputs of the data frame either the “data” column of the nested data frame or the individual columns of interest. So in the function below, I want to get predicted values, so I take a model object as input and output a data frame of predicted values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>pred_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(mod){</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossing</span>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">t.value =</span> <span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">7</span>,.<span class="dv">25</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">pred =</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> .))</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>(ipip50_nested <span class="ot">&lt;-</span> ipip50_nested <span class="sc">%&gt;%</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred =</span> <span class="fu">map</span>(model, pred_fun)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 6
   Trait Outcome   data                 model  tidy             pred    
   &lt;chr&gt; &lt;chr&gt;     &lt;list&gt;               &lt;list&gt; &lt;list&gt;           &lt;list&gt;  
 1 A     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
 2 C     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
 3 E     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
 4 N     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
 5 O     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
 6 A     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
 7 C     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
 8 E     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
 9 N     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
10 O     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
11 A     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
12 C     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
13 E     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
14 N     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;
15 O     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt;</code></pre>
</div>
</div>
<p>Now, let’s take those predicted values and use them to make individual plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>plot_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(df, trait, outcome){</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t.value, <span class="at">y =</span> pred)) <span class="sc">+</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">x =</span> trait, <span class="at">y =</span> outcome) <span class="sc">+</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_classic</span>()</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>(ipip50_nested <span class="ot">&lt;-</span> ipip50_nested <span class="sc">%&gt;%</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">plot =</span> <span class="fu">pmap</span>(<span class="fu">list</span>(pred, Trait, Outcome), plot_fun)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 7
   Trait Outcome   data                 model  tidy             pred     plot  
   &lt;chr&gt; &lt;chr&gt;     &lt;list&gt;               &lt;list&gt; &lt;list&gt;           &lt;list&gt;   &lt;list&gt;
 1 A     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
 2 C     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
 3 E     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
 4 N     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
 5 O     BMI       &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
 6 A     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
 7 C     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
 8 E     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
 9 N     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
10 O     exer      &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
11 A     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
12 C     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
13 E     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
14 N     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  
15 O     logMedInc &lt;tibble [1,000 × 5]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt; &lt;tibble&gt; &lt;gg&gt;  </code></pre>
</div>
</div>
<p>Let’s take a look at how this plot actually looks:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>ipip50_nested<span class="sc">$</span>plot[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="purrr_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Meh, not a fan. Let’s do better and combine prediction lines across traits within outcomes. We’ll do this two ways: (1) separately for each outcome and (2) using facets across all outcomes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>ipip50_nested <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(pred) <span class="sc">%&gt;%</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t.value, <span class="at">y =</span> pred, <span class="at">color =</span> Trait)) <span class="sc">+</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>Outcome, <span class="at">scale =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="purrr_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Meh, this is fine, but the scale’s off. This is what I’d call a “wow graph” because it exaggerates the differences. I could write some code to put each graph on a realistic scale for the outcome, but for now, I won’t.</p>
<div class="cell">

</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./dplyr.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Data Manipulation: Intro to <code>dplyr</code></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./ggplot2.html" class="pagination-link">
        <span class="nav-page-text">Introduction to ggplot2</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022, Emorie D Beck</div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/emoriebeck">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/EmorieBeck">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>